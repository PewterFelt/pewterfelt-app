---
name: Create/Update preview release

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-preview:
    runs-on: ubuntu-latest
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  # build-android-preview:
  #   name: Build Android App (preview)
  #   needs: release-preview
  #   if: ${{ needs.release-preview.outputs.release_created }}
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Check for EXPO_TOKEN
  #       run: >
  #         if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
  #           echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
  #           exit 1
  #         fi
  #
  #     - name: â¬‡ï¸ Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 5
  #
  #     - name: ðŸ”§ Setup Bun
  #       uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest
  #
  #     - name: ðŸ”¨ Setup EAS
  #       uses: expo/expo-github-action@v8
  #       with:
  #         expo-version: latest
  #         eas-version: latest
  #         token: ${{ secrets.EXPO_TOKEN }}
  #
  #     - name: âš™ï¸ Install dependencies
  #       run: bun install
  #
  #     - name: ðŸ“¦ Check Dependencies
  #       run: bunx expo install --check
  #
  #     - name: ðŸ§‘â€âš•ï¸ Expo Doctor
  #       run: bunx expo-doctor
  #
  #     - name: ðŸ—ï¸ EAS Build
  #       run: eas build -p android --profile preview --non-interactive --output build.aab --local
  #
  #     - name: âœï¸ Rename preview bundle
  #       run: mv build.aab build.apk
  #
  #     - name: ðŸš€ Upload Preview Artifact
  #       id: upload-artifact-preview
  #       run: gh release upload ${{ needs.release-preview.outputs.tag_name }} build.apk
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #
  #     - name: â¬‡ï¸ Restore Cache
  #       id: get-base-commit
  #       uses: actions/cache@v4
  #       with:
  #         path: most-recent-preview-commit.txt
  #         key: most-recent-preview-commit
  #
  #     - name: âœï¸ Write commit hash to cache
  #       run: echo ${{ github.sha }} > most-recent-preview-commit.txt
  #
  # build-ios-preview:
  #   name: Build iOS App (preview)
  #   needs: release-preview
  #   if: ${{ needs.release-preview.outputs.release_created }}
  #   runs-on: macos-15
  #   steps:
  #     - name: Check for EXPO_TOKEN
  #       run: >
  #         if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
  #           echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
  #           exit 1
  #         fi
  #
  #     - name: â¬‡ï¸ Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 5
  #
  #     - name: ðŸ”§ Setup Bun
  #       uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest
  #
  #     - name: ðŸ”¨ Setup EAS
  #       uses: expo/expo-github-action@v8
  #       with:
  #         expo-version: latest
  #         eas-version: latest
  #         token: ${{ secrets.EXPO_TOKEN }}
  #
  #     - name: âš™ï¸ Install dependencies
  #       run: bun install
  #
  #     - name: ðŸ“¦ Check Dependencies
  #       run: bunx expo install --check
  #
  #     - name: ðŸ§‘â€âš•ï¸ Expo Doctor
  #       run: bunx expo-doctor
  #
  #     - name: ðŸ’» Setup Xcode
  #       uses: maxim-lobanov/setup-xcode@v1
  #       with:
  #         xcode-version: latest-stable
  #
  #     - name: â˜•ï¸ Setup Cocoapods
  #       uses: maxim-lobanov/setup-cocoapods@v1
  #       with:
  #         version: latest-stable
  #
  #     - name: ðŸ’¾ Cache Pods
  #       id: pods-cache
  #       uses: actions/cache@v3
  #       with:
  #         path: ./ios/Pods
  #         # We'll use the pnpm-lock.yml for our hash since we don't yet have a Podfile.lock. Pod versions will not
  #         # change unless the pnpm version changes as well.
  #         key: ${{ runner.os }}-pods-${{ hashFiles('pnpm-lock.yml') }}
  #
  #     - name: ðŸ—ï¸ EAS Build
  #       run: eas build -p ios --profile preview --non-interactive --output build.ipa --local
  #
  #     - name: ðŸš€ Upload Preview Artifact
  #       id: upload-artifact-preview
  #       run: gh release upload ${{ needs.release-preview.outputs.tag_name }} build.ipa
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #
  #     - name: ðŸš€ Submit to TestFlight
  #       run: eas submit -p ios --non-interactive --path build.ipa
  #
  #     - name: â¬‡ï¸ Restore Cache
  #       id: get-base-commit
  #       uses: actions/cache@v4
  #       with:
  #         path: most-recent-preview-commit.txt
  #         key: most-recent-preview-commit
  #
  #     - name: âœï¸ Write commit hash to cache
  #       run: echo ${{ github.sha }} > most-recent-preview-commit.txt
